# IAM Checker

## tf-iam-checker

- [Overview](#overview)
  - [Diagrams](#diagrams)
  - [References](#references)
- [Prerequisites](#prerequisites)
- [Quick Start](#quick-start)
  - [Validate Terraform](#validate-terraform)
  - [Deploy from client machine](#deploy-from-client-machine)
  - [Troubleshooting](#troubleshooting)
  - [Destroy Environment](#destroy-environment)
- [Terraform Docs](#terraform-docs)

## Overview

### Diagrams

### References

## Prerequisites

### Tooling
- Terraform
- Git
- AWS CLI
- Terraform-Docs
- TF-Lint
- Checkov
- Pre-Commit

#### Configure AWS CLI
Run this command to quickly set and view your credentials, region, and output format\. The following example shows sample values\.

```
$ aws configure
AWS Access Key ID [None]: AKIAIOSFODNN7EXAMPLE
AWS Secret Access Key [None]: wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
Default region name [None]: us-west-2
Default output format [None]: json
```

 For example, the files generated by the CLI for a default profile configured with `aws configure` looks similar to the following\.

**`~/.aws/credentials`**

```
[default]
aws_access_key_id=AKIAIOSFODNN7EXAMPLE
aws_secret_access_key=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
```

**`~/.aws/config`**

```
[default]
region=us-west-2
output=json
```

## Quick Start

### Validate Terraform

Format
```bash
terraform fmt -recursive
```

Validate
```bash
terraform validate
```

Static Code Analysis
```bash
checkov -s -d .
```

Lint
```bash
tflint --init --loglevel=info
tflint --module --loglevel=info
```

Terraform-Docs
```bash
terraform-docs .
```

Pre-commit
```bash
pre-commit install
pre-commit run --all-files
```

### Deploy from client machine

Initialise the Terraform to install any modules and providers.

```bash
terraform init
```

Select the appropriate Terraform Workspace
    Workspaces:
* mgmt

```bash
terraform workspace select <Workspace>
```

Run terraform plan to check if any changes will be made to infrastructure.

```bash
terraform plan
```

Run terraform apply to deploy any changes to infrastructure.

```bash
terraform apply --auto-approve
```

### Troubleshooting

If the Terraform state is locked
```bash
terraform force-unlock <state-lock-id>
```

Listing available Terraform Workspaces
```bash
terraform workspace list
```

Upgrade Terraform Providers
```bash
terraform init --upgrade
git add .
git commit -m "upgrade terraform provider versions within pinned config"
git push
```

To use the a named profile without having to pass the --profile arg or hardcoding in your code you can set an environment variable.
```bash
export AWS_PROFILE=mgmt
```

### Destroy Environment

To destroy a specific environment you need to run from a client machine.

Initialise the Terraform to install any modules and providers.

```bash
terraform init
```

Select the appropriate Terraform Workspace
    Workspaces:
* mgmt

```bash
terraform workspace select <Workspace>
```

Destroy the provisioned infrastructure in the target environment.

```bash
terraform destroy --auto-approve
```

## Terraform-Docs

<!-- BEGIN_TF_DOCS -->
#### Requirements

| Name | Version |
|------|---------|
| terraform | ~> 1.0 |
| aws | ~> 4.0 |

#### Providers

| Name | Version |
|------|---------|
| aws | ~> 4.0 |

#### Modules

| Name | Source | Version |
|------|--------|---------|
| lambda | ./modules/lambda | n/a |

#### Resources

| Name | Type |
|------|------|
| [aws_route53_record.dkim](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/route53_record) | resource |
| [aws_route53_record.mx](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/route53_record) | resource |
| [aws_route53_record.txt](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/route53_record) | resource |
| [aws_route53_record.verification](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/route53_record) | resource |
| [aws_ses_domain_dkim.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/ses_domain_dkim) | resource |
| [aws_ses_domain_identity.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/ses_domain_identity) | resource |
| [aws_ses_domain_identity_verification.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/ses_domain_identity_verification) | resource |
| [aws_ses_domain_mail_from.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/ses_domain_mail_from) | resource |
| [aws_ses_template.iam_checker](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/ses_template) | resource |
| [aws_iam_policy_document.iam_checker_policy](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/iam_policy_document) | data source |
| [aws_route53_zone.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/route53_zone) | data source |

#### Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| domain_name | The domain name to use for SES | `string` | n/a | yes |

#### Outputs

No outputs.
<!-- END_TF_DOCS -->

### Lambda Module

<!-- BEGIN_LAMBDA_DOCS -->
#### Requirements

No requirements.

#### Providers

| Name | Version |
|------|---------|
| aws | n/a |

#### Modules

No modules.

#### Resources

| Name | Type |
|------|------|
| [aws_cloudwatch_event_rule.schedule](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_event_rule) | resource |
| [aws_cloudwatch_event_target.schedule](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_event_target) | resource |
| [aws_cloudwatch_log_group.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_log_group) | resource |
| [aws_cloudwatch_metric_alarm.lambda_errors](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_metric_alarm) | resource |
| [aws_cloudwatch_metric_alarm.lambda_timeouts](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_metric_alarm) | resource |
| [aws_iam_role.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role) | resource |
| [aws_iam_role_policy.role-policy-attachment-managed](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role_policy) | resource |
| [aws_iam_role_policy_attachment.role-policy-attachment-default](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role_policy_attachment) | resource |
| [aws_lambda_alias.main](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lambda_alias) | resource |
| [aws_lambda_function.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lambda_function) | resource |
| [aws_lambda_permission.schedule](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lambda_permission) | resource |
| [aws_iam_policy_document.assumerole](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/iam_policy_document) | data source |
| [aws_s3_object.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/s3_object) | data source |

#### Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| additional_env_vars | A map of key value pairs for environment variables. | `map(string)` | `{}` | no |
| alarms_enabled | Do we want to enable alarms? | `bool` | `false` | no |
| cloudwatch_schedule | Do we want to run the Lambda on a schedule, what frequency etc | `string` | `null` | no |
| code_zip | The lambda package zip | `string` | n/a | yes |
| custom_policy | custom policy | `string` | `""` | no |
| errors_alarm_evaluation_periods | The evaluation period for which the alarm triggers for errors | `number` | `2` | no |
| errors_alarm_period | The period for which the alarm triggers for errors | `number` | `60` | no |
| errors_alarm_threshold | The threshold at which the alarm triggers for errors | `number` | `1` | no |
| handler | filename.function called by Lambda | `string` | `"lambda_function.lambda_handler"` | no |
| lambda_name | What is the name of the lambda function | `string` | n/a | yes |
| log_retention_in_days | Number of days we want to retain logs for | `number` | `365` | no |
| managed_policies | List of aws managed Iam policies to be attached to lambda | `list(string)` | `[]` | no |
| memory_size | Memory size required for the lambda | `number` | `128` | no |
| region | The AWS region to deploy into. Defaults to `eu-west-1` | `string` | `"eu-west-1"` | no |
| reserved_concurrent_executions | Reserved concurrency for the lambda | `number` | `null` | no |
| runtime | The lambda runtime, defaults to `python3.9` | `string` | `"python3.9"` | no |
| s3_bucket | The S3 bucket to pull the lambda zip from. | `string` | n/a | yes |
| s3_key | Lambda Package stored as S3 Object | `string` | `null` | no |
| timeout | Timeout for the lambda | `number` | `3` | no |
| timeout_alarm_evaluation_periods | The evaluation period for which the alarm triggers for timeouts | `number` | `2` | no |
| timeout_alarm_period | The period for which the alarm triggers for timeouts | `number` | `60` | no |
| timeout_alarm_threshold | The threshold at which the alarm triggers for timeouts | `number` | `1` | no |

#### Outputs

| Name | Description |
|------|-------------|
| lambda_arn | n/a |
| lambda_invoke_arn | n/a |
| lambda_name | n/a |
| role_arn | n/a |
| role_name | n/a |
<!-- END_LAMBDA_DOCS -->